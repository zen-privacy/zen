stages:
  - build
  - package
  - release

variables:
  CARGO_NET_GIT_FETCH_WITH_CLI: "true"
  RUSTFLAGS: "-C target-cpu=native"

# Linux build (deb + rpm)
build-linux:
  stage: build
  image: node:20-bullseye
  tags: []
  script:
    - apt-get update
    - apt-get install -y --no-install-recommends
        libwebkit2gtk-4.0-dev
        libayatana-appindicator3-dev
        librsvg2-dev
        libglib2.0-dev
        patchelf
        rpm
        pkg-config
        curl
        git
        build-essential
    - curl https://sh.rustup.rs -sSf | sh -s -- -y
    - source "$HOME/.cargo/env"
    - npm ci
    - npx tauri --help >/dev/null 2>&1 || npm install -g @tauri-apps/cli
    - npm run tauri build
  artifacts:
    when: on_success
    expire_in: 7 days
    paths:
      - src-tauri/target/release/bundle/deb/*.deb
      - src-tauri/target/release/bundle/rpm/*.rpm

# Windows build (NSIS exe). Requires a Windows runner with tag "windows".
build-windows:
  stage: build
  tags: ["windows"]
  script:
    - choco install -y nodejs-lts
    - refreshenv
    - npm ci
    - npm install -g @tauri-apps/cli
    - rustup default stable
    - npm run tauri build
  artifacts:
    when: on_success
    expire_in: 7 days
    paths:
      - src-tauri/target/release/bundle/nsis/*.exe

# Create manifest.json with sha256 and release URLs
manifest:
  stage: package
  image: node:20-alpine
  needs:
    - build-linux
    - build-windows
  script:
    - apk add --no-cache coreutils jq
    - VERSION=$(node -e "console.log(require('./package.json').version)")
    - WIN_FILE=$(ls src-tauri/target/release/bundle/nsis/*.exe 2>/dev/null | head -n1)
    - DEB_FILE=$(ls src-tauri/target/release/bundle/deb/*.deb 2>/dev/null | head -n1)
    - RPM_FILE=$(ls src-tauri/target/release/bundle/rpm/*.rpm 2>/dev/null | head -n1)
    - WIN_SHA=$( [ -n "$WIN_FILE" ] && sha256sum "$WIN_FILE" | awk '{print $1}' || echo "" )
    - DEB_SHA=$( [ -n "$DEB_FILE" ] && sha256sum "$DEB_FILE" | awk '{print $1}' || echo "" )
    - RPM_SHA=$( [ -n "$RPM_FILE" ] && sha256sum "$RPM_FILE" | awk '{print $1}' || echo "" )
    - BASE="https://gitlab.com/${CI_PROJECT_PATH}/-/releases/v${VERSION}/downloads"
    - |
      cat > manifest.json <<'EOF'
      {
        "version": "__VERSION__",
        "notes": "Auto-generated from CI for v__VERSION__",
        "assets": {
          "windows": {
            "url": "__BASE__/__WIN__",
            "sha256": "__WIN_SHA__"
          },
          "deb": {
            "url": "__BASE__/__DEB__",
            "sha256": "__DEB_SHA__"
          },
          "rpm": {
            "url": "__BASE__/__RPM__",
            "sha256": "__RPM_SHA__"
          }
        }
      }
      EOF
      sed -i "s|__VERSION__|${VERSION}|g" manifest.json
      sed -i "s|__BASE__|${BASE}|g" manifest.json
      sed -i "s|__WIN__|$(basename "$WIN_FILE")|g" manifest.json
      sed -i "s|__DEB__|$(basename "$DEB_FILE")|g" manifest.json
      sed -i "s|__RPM__|$(basename "$RPM_FILE")|g" manifest.json
      sed -i "s|__WIN_SHA__|${WIN_SHA}|g" manifest.json
      sed -i "s|__DEB_SHA__|${DEB_SHA}|g" manifest.json
      sed -i "s|__RPM_SHA__|${RPM_SHA}|g" manifest.json
    - cat manifest.json
  artifacts:
    when: on_success
    expire_in: 7 days
    paths:
      - manifest.json

# Publish GitLab release with assets (requires GITLAB_TOKEN and tag vX.Y.Z)
release:
  stage: release
  image: alpine:3.19
  needs:
    - build-linux
    - build-windows
    - manifest
  rules:
    - if: '$CI_COMMIT_TAG'
  script:
    - apk add --no-cache curl jq
    - test -n "$GITLAB_TOKEN" || { echo "GITLAB_TOKEN is required"; exit 1; }
    - VERSION="$CI_COMMIT_TAG"
    - echo "Releasing $VERSION"
    - >
      upload() { curl --header "PRIVATE-TOKEN: ${GITLAB_TOKEN}" --upload-file "$1" "https://gitlab.com/api/v4/projects/${CI_PROJECT_ID}/uploads"; }
    - WIN_FILE=$(ls src-tauri/target/release/bundle/nsis/*.exe 2>/dev/null | head -n1)
    - DEB_FILE=$(ls src-tauri/target/release/bundle/deb/*.deb 2>/dev/null | head -n1)
    - RPM_FILE=$(ls src-tauri/target/release/bundle/rpm/*.rpm 2>/dev/null | head -n1)
    - MAN_FILE="manifest.json"
    - WIN_LINK=$(upload "$WIN_FILE" | jq -r .url)
    - DEB_LINK=$(upload "$DEB_FILE" | jq -r .url)
    - RPM_LINK=$(upload "$RPM_FILE" | jq -r .url)
    - MAN_LINK=$(upload "$MAN_FILE" | jq -r .url)
    - >
      curl --header "PRIVATE-TOKEN: ${GITLAB_TOKEN}" --request POST "https://gitlab.com/api/v4/projects/${CI_PROJECT_ID}/releases" --data "name=${VERSION}" --data "tag_name=${VERSION}" --data-urlencode "description=Automated release ${VERSION}" --data-urlencode "assets[links][][name]=Windows EXE" --data-urlencode "assets[links][][url]=${CI_PROJECT_URL}${WIN_LINK}" --data-urlencode "assets[links][][name]=Linux DEB" --data-urlencode "assets[links][][url]=${CI_PROJECT_URL}${DEB_LINK}" --data-urlencode "assets[links][][name]=Linux RPM" --data-urlencode "assets[links][][url]=${CI_PROJECT_URL}${RPM_LINK}" --data-urlencode "assets[links][][name]=manifest.json" --data-urlencode "assets[links][][url]=${CI_PROJECT_URL}${MAN_LINK}"

